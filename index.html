<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Survival ‚Üí Stability System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
  background:#0b1220;
  color:#fff;
}
.container{
  max-width:900px;
  margin:auto;
  padding:16px;
}
.card{
  background:#111a2e;
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
}
h1,h2{
  margin:0 0 12px;
}
input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  margin-bottom:10px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  font-size:16px;
  background:#22c55e;
  color:#000;
  font-weight:600;
}
.alert{
  padding:10px;
  border-radius:8px;
  margin-top:8px;
}
.green{background:#16a34a;}
.red{background:#dc2626;}
.yellow{background:#ca8a04;}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  margin-top:8px;
}
th,td{
  border-bottom:1px solid #1f2a44;
  padding:8px;
  text-align:center;
}
canvas{
  max-width:100%;
  max-height:260px;
}
.small{
  font-size:13px;
  opacity:.85;
}
</style>
</head>

<body>
<div class="container">

<h1>üß† Survival ‚Üí Stability System</h1>
<p class="small">Local storage + Google Sheet backup + Auto guidance + Charts</p>

<!-- DAILY ENTRY -->
<div class="card">
<h2>üìÖ Daily Entry</h2>

<select id="month">
  <option>January</option><option>February</option><option>March</option>
  <option>April</option><option>May</option><option>June</option>
  <option>July</option><option>August</option><option>September</option>
  <option>October</option><option>November</option><option>December</option>
</select>

<input id="salary" type="number" placeholder="Salary received today (‚Çπ)">
<input id="withdraw" type="number" placeholder="Trading Withdraw (‚Çπ)">
<input id="grocery" type="number" placeholder="Grocery (‚Çπ)">
<input id="travel" type="number" placeholder="Travel (‚Çπ)">
<input id="other" type="number" placeholder="Other Essential (‚Çπ)">

<select id="mood">
  <option>ok</option>
  <option>stressed</option>
  <option>tired</option>
</select>

<button id="saveBtn">Analyze ‚Ä¢ Save ‚Ä¢ Guide</button>
</div>

<!-- TODAY SUMMARY -->
<div class="card">
<h2>üìå Today Summary</h2>
<div id="todaySummary"></div>
</div>

<!-- CURRENT MONTH SUMMARY -->
<div class="card">
<h2>üìÜ Current Month Summary</h2>
<div id="monthSummary"></div>
<table>
<thead>
<tr><th>Date</th><th>Withdraw</th><th>Expense</th><th>Balance</th></tr>
</thead>
<tbody id="monthTable"></tbody>
</table>
</div>

<!-- HISTORY -->
<div class="card">
<h2>üìÇ History (All)</h2>
<table>
<thead>
<tr><th>Date</th><th>Month</th><th>Withdraw</th><th>Expense</th><th>Balance</th></tr>
</thead>
<tbody id="historyTable"></tbody>
</table>
</div>

<!-- VISUALS -->
<div class="card">
<h2>üìä Today Visual</h2>
<canvas id="todayPie"></canvas>
<canvas id="todayBar"></canvas>
</div>

<div class="card">
<h2>üìä Current Month Visual</h2>
<canvas id="monthPie"></canvas>
<canvas id="monthBar"></canvas>
</div>

</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbycZmT_n66WVFc4t3CFyo7UM7mQg1BGeKHbcE04wH3o4waopuTvcJ44JCkDloMqOyuFtg/exec";

let todayPie, todayBar, monthPie, monthBar;

function saveToday(){
  const rec = {
    date: new Date().toLocaleDateString("en-GB"),
    month: month.value,
    salary: +salary.value||0,
    withdraw: +withdraw.value||0,
    grocery: +grocery.value||0,
    travel: +travel.value||0,
    other: +other.value||0,
    mood: mood.value
  };

  rec.expense = rec.grocery + rec.travel + rec.other;
  rec.balance = rec.withdraw - rec.expense;

  // localStorage save
  let logs = JSON.parse(localStorage.getItem("financeLogs")||"[]");
  logs.push(rec);
  localStorage.setItem("financeLogs", JSON.stringify(logs));

  // Google Sheet save
  fetch(SHEET_URL, {
    method: "POST",
    body: JSON.stringify({
      Date: rec.date,
      Month: rec.month,
      Salary: rec.salary,
      Withdraw: rec.withdraw,
      Grocery: rec.grocery,
      Travel: rec.travel,
      Other: rec.other,
      Total_Expense: rec.expense,
      Mood: rec.mood,
      Net_Balance: rec.balance
    })
  }).catch(()=>{});

  render();
}

function render(){
  const logs = JSON.parse(localStorage.getItem("financeLogs")||"[]");
  if(!logs.length) return;

  const today = logs[logs.length-1];

  todaySummary.innerHTML = `
    <div class="alert green">Withdraw ‚Çπ${today.withdraw} | Expense ‚Çπ${today.expense} | Balance ‚Çπ${today.balance}</div>
    ${today.expense > 500 ? `<div class="alert red">‚ö†Ô∏è Expense high. Tomorrow limit ‚Çπ400</div>` : ""}
    <div class="alert yellow">üéØ Rule: Survival > Profit</div>
  `;

  // month summary
  const monthLogs = logs.filter(l=>l.month === today.month);
  const mWithdraw = monthLogs.reduce((a,b)=>a+b.withdraw,0);
  const mExpense = monthLogs.reduce((a,b)=>a+b.expense,0);

  monthSummary.innerHTML = `
    <div class="alert yellow">Withdraw ‚Çπ${mWithdraw} | Expense ‚Çπ${mExpense}</div>
  `;

  monthTable.innerHTML = monthLogs.map(l =>
    `<tr><td>${l.date}</td><td>${l.withdraw}</td><td>${l.expense}</td><td>${l.balance}</td></tr>`
  ).join("");

  historyTable.innerHTML = logs.map(l =>
    `<tr><td>${l.date}</td><td>${l.month}</td><td>${l.withdraw}</td><td>${l.expense}</td><td>${l.balance}</td></tr>`
  ).join("");

  drawCharts(today, monthLogs);
}

function drawCharts(today, monthLogs){
  const tExp = [today.grocery, today.travel, today.other];
  const mExp = [
    monthLogs.reduce((a,b)=>a+b.grocery,0),
    monthLogs.reduce((a,b)=>a+b.travel,0),
    monthLogs.reduce((a,b)=>a+b.other,0)
  ];
  const mWithdraw = monthLogs.reduce((a,b)=>a+b.withdraw,0);
  const mExpense = monthLogs.reduce((a,b)=>a+b.expense,0);

  // destroy
  if(todayPie) todayPie.destroy();
  if(todayBar) todayBar.destroy();
  if(monthPie) monthPie.destroy();
  if(monthBar) monthBar.destroy();

  todayPie = new Chart(todayPieCtx, {
    type: "doughnut",
    data: {
      labels: ["Grocery","Travel","Other"],
      datasets: [{data: tExp, backgroundColor:["#22c55e","#3b82f6","#fb923c"]}]
    }
  });

  todayBar = new Chart(todayBarCtx, {
    type:"bar",
    data:{
      labels:["Withdraw","Expense"],
      datasets:[{data:[today.withdraw, today.expense], backgroundColor:["#16a34a","#dc2626"]}]
    }
  });

  monthPie = new Chart(monthPieCtx, {
    type:"doughnut",
    data:{
      labels:["Grocery","Travel","Other"],
      datasets:[{data:mExp, backgroundColor:["#22c55e","#3b82f6","#fb923c"]}]
    }
  });

  monthBar = new Chart(monthBarCtx, {
    type:"bar",
    data:{
      labels:["Withdraw","Expense"],
      datasets:[{data:[mWithdraw, mExpense], backgroundColor:["#16a34a","#dc2626"]}]
    }
  });
}

document.getElementById("saveBtn").addEventListener("click",saveToday);

window.onload = render;

const todayPieCtx = document.getElementById("todayPie");
const todayBarCtx = document.getElementById("todayBar");
const monthPieCtx = document.getElementById("monthPie");
const monthBarCtx = document.getElementById("monthBar");

</script>

</body>
</html>
